<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì—°ì„¸ ì´ë©”ì¼ ì¸ì¦</title>

  <!-- âœ… Firebase SDK: gstaticì—ì„œ ì§ì ‘ ë¡œë“œ -->
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

  <!-- âœ… Hostingì´ ìë™ ì£¼ì…í•˜ëŠ” init (firebase.initializeApp í¬í•¨) -->
  <script src="/__/firebase/init.js"></script>

  <style>
    body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; background:#f5f6f8; margin:0; }
    .container { max-width:420px; margin:120px auto; background:#fff; padding:32px; border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,.08); text-align:center; }
    h1 { font-size:20px; margin:0 0 16px; }
    p { font-size:14px; color:#555; line-height:1.6; margin:0; }
    .success { color:#2e7d32; font-weight:600; }
    .error { color:#c62828; font-weight:600; }
    .muted { color:#888; font-size:12px; margin-top:10px; }
    code { background:#f1f3f5; padding:2px 6px; border-radius:6px; }
  </style>
</head>

<body>
  <div class="container">
    <h1>í•™ìƒ ì¸ì¦ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤â€¦</h1>
    <p id="status">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
    <p class="muted" id="debug"></p>
  </div>

  <script>
    (async () => {
      // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
      if (window.__EMAIL_LINK_RUNNING__) return;
      window.__EMAIL_LINK_RUNNING__ = true;

      const statusEl = document.getElementById('status');
      const debugEl = document.getElementById('debug');

      const setStatus = (html) => { statusEl.innerHTML = html; };
      const setDebug = (html) => { if (debugEl) debugEl.innerHTML = html; };

      // firebase ê°ì²´ ì¤€ë¹„ ëŒ€ê¸°
      const waitFirebase = async (timeoutMs = 12000) => {
        const start = Date.now();
        while (Date.now() - start < timeoutMs) {
          if (window.firebase && firebase.apps && firebase.apps.length >= 0 && firebase.auth && firebase.firestore) {
            // init.jsê°€ ì‹¤í–‰ë˜ì–´ initializeAppê¹Œì§€ ëë‚¬ëŠ”ì§€ ì²´í¬
            try {
              firebase.app();
              return true;
            } catch (_) {
              // ì•„ì§ initializeApp ì•ˆ ëì„ ìˆ˜ ìˆìŒ
            }
          }
          await new Promise(r => setTimeout(r, 80));
        }
        return false;
      };

      // âœ… t ì¶”ì¶œ: 1) í˜„ì¬ URL ì¿¼ë¦¬ìŠ¤íŠ¸ë§ 2) continueUrl íŒŒë¼ë¯¸í„° ë‚´ë¶€
      function extractTokenFromUrl(href) {
        try {
          const u = new URL(href);
          // 1) ì§ì ‘ t=...
          let t = u.searchParams.get('t');
          if (t) return t;

          // 2) continueUrl ë‚´ë¶€ì— tê°€ ë“¤ì–´ìˆëŠ” ì¼€ì´ìŠ¤
          // ì˜ˆ: ...&continueUrl=https%3A%2F%2Fseolleyeon.web.app%2Fauth%2Femail-link%3Ft%3Dxxxx
          const cont = u.searchParams.get('continueUrl');
          if (cont) {
            const decoded = decodeURIComponent(cont);
            const cu = new URL(decoded);
            t = cu.searchParams.get('t');
            if (t) return t;
          }

          // 3) í˜¹ì‹œ query ì „ì²´ê°€ encodeëœ íŠ¹ì´ì¼€ì´ìŠ¤ ëŒ€ë¹„
          // (ë§ˆì§€ë§‰ ë³´í—˜)
          const m = href.match(/[?&]t=([^&]+)/);
          if (m && m[1]) return decodeURIComponent(m[1]);
        } catch (e) {}
        return null;
      }

      // âœ… firebase email-link URLì€ í˜„ì¬ location.hrefê°€ ì•„ë‹ˆë¼ "ì›ë³¸ ë§í¬"ë¥¼ ì¨ì•¼ í•¨
      // ë³´í†µì€ location.href ê·¸ëŒ€ë¡œ OK. ë‹¤ë§Œ ì¼ë¶€ ì¸ì•± ë¸Œë¼ìš°ì €ì—ì„œ fragment/param ë³€í˜•ì´ ìˆìŒ.
      const rawUrl = window.location.href;

      try {
        setStatus('â³ Firebase ì¤€ë¹„ ì¤‘â€¦');
        const ok = await waitFirebase();
        if (!ok) {
          throw new Error('Firebase SDK/init ë¡œë“œ ì‹¤íŒ¨. (Hosting init.js ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ)');
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // token ì¶”ì¶œ
        const token = extractTokenFromUrl(rawUrl);
        setDebug(`URL: <code>${rawUrl.replace(/</g, '&lt;')}</code><br/>t: <code>${token || 'null'}</code>`);

        setStatus('â³ ë§í¬ í™•ì¸ ì¤‘â€¦');

        // Firebase email linkì¸ì§€ í™•ì¸
        if (!auth.isSignInWithEmailLink(rawUrl)) {
          throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì¸ì¦ ë§í¬ì…ë‹ˆë‹¤. (Firebase ì´ë©”ì¼ ë§í¬ ì•„ë‹˜)');
        }

        if (!token) {
          throw new Error('í† í°(t)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì•±ì—ì„œ ë‹¤ì‹œ ì¸ì¦ ë§í¬ë¥¼ ë³´ë‚´ì£¼ì„¸ìš”.');
        }

        setStatus('â³ í† í° ì¡°íšŒ ì¤‘â€¦');

        const tokenRef = db.collection('emailLinkTokens').doc(token);
        const tokenSnap = await tokenRef.get();

        if (!tokenSnap.exists) {
          throw new Error('í† í° ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. (ë§Œë£Œ/ì‚­ì œ/ê¶Œí•œ ë¬¸ì œ ê°€ëŠ¥)');
        }

        const data = tokenSnap.data() || {};
        const email = data.email;
        const kakaoUserId = data.kakaoUserId;
        const expiresAt = data.expiresAt;

        if (!email || !kakaoUserId) {
          throw new Error('í† í° ë°ì´í„°(email/kakaoUserId)ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

        // ë§Œë£Œ ì²´í¬ (ìˆìœ¼ë©´)
        if (expiresAt && typeof expiresAt.toDate === 'function') {
          const exp = expiresAt.toDate();
          if (Date.now() > exp.getTime()) {
            // ë§Œë£Œë©´ í† í° ì‚­ì œ ì‹œë„ í›„ ì¢…ë£Œ
            try { await tokenRef.delete(); } catch (_) {}
            throw new Error('í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì•±ì—ì„œ ë‹¤ì‹œ ì¸ì¦ ë§í¬ë¥¼ ë³´ë‚´ì£¼ì„¸ìš”.');
          }
        }

        setStatus('â³ ì´ë©”ì¼ ì¸ì¦ ì²˜ë¦¬ ì¤‘â€¦');

        // ì´ë©”ì¼ ë§í¬ ë¡œê·¸ì¸
        const result = await auth.signInWithEmailLink(email, rawUrl);
        if (!result || !result.user) {
          throw new Error('ì¸ì¦ ì‹¤íŒ¨(user ì—†ìŒ).');
        }

        setStatus('â³ í•™ìƒ ì¸ì¦ ì €ì¥ ì¤‘â€¦');

        // í•™ìƒ ì¸ì¦ ì™„ë£Œ í‘œì‹œ
        await db.collection('users').doc(String(kakaoUserId)).set({
          isStudentVerified: true,
          studentEmail: email,
          verifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
        }, { merge: true });

        // í† í° ì¬ì‚¬ìš© ë°©ì§€ ì‚­ì œ
        try { await tokenRef.delete(); } catch (_) {}

        setStatus(
          '<span class="success">ğŸ‰ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!<br/>ì•±ìœ¼ë¡œ ëŒì•„ê°€ì„œ ë‹¤ìŒì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.</span>'
        );

      } catch (e) {
        console.error(e);
        const msg = (e && e.message) ? e.message : String(e);

        setStatus(
          '<span class="error">ì¸ì¦ ì¤‘ ì˜¤ë¥˜: ' + msg + '<br/>ì•±ì—ì„œ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</span>'
        );
      }
    })();
  </script>
</body>
</html>